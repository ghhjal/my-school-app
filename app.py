import streamlit as st
import gspread
from google.oauth2.service_account import Credentials
import pandas as pd

# 1. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØµÙØ­Ø© Ø§Ù„ÙØ®Ù…Ø©
st.set_page_config(page_title="Ù†Ø¸Ø§Ù… Ø§Ù„Ø£Ø³ØªØ§Ø° Ø²ÙŠØ§Ø¯ - Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø°ÙƒÙŠØ©", layout="wide")

st.markdown("""
    <style>
    .main { background-color: #f4f7f6; }
    .stButton>button { border-radius: 25px; font-weight: bold; transition: 0.3s; }
    .stTabs [data-baseweb="tab-list"] { background-color: #f8f9fa; padding: 10px; border-radius: 15px; }
    .student-card { 
        background-color: white; padding: 20px; border-radius: 15px; 
        border-right: 8px solid #d4af37; margin-bottom: 15px; 
        box-shadow: 0 4px 6px rgba(0,0,0,0.1); 
    }
    h1 { color: #1a1a1a; font-family: 'Amiri', serif; text-align: center; border-bottom: 3px solid #d4af37; padding-bottom: 15px; }
    </style>
    """, unsafe_allow_html=True)

# 2. Ø§Ù„Ø±Ø¨Ø· Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠ
@st.cache_resource
def get_gspread_client():
    scope = ["https://www.googleapis.com/auth/spreadsheets"]
    creds = Credentials.from_service_account_info(st.secrets["gcp_service_account"], scopes=scope)
    return gspread.authorize(creds)

try:
    client = get_gspread_client()
    sh = client.open_by_key("1_GSVxCKCamdoydymH6Nt5NQ0C_mmQfGTNrnb9ilUD_c")
    ws = sh.worksheet("students")

    # Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©
    with st.sidebar:
        st.image("https://cdn-icons-png.flaticon.com/512/3426/3426653.png", width=80)
        st.title("Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø£Ø³ØªØ§Ø° Ø²ÙŠØ§Ø¯")
        page = st.radio("Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…ØªØ§Ø­Ø©:", ["ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©", "ğŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ ÙˆØ§Ù„ØªØ­ÙƒÙ…", "ğŸ“Š Ø§Ù„Ø¯Ø±Ø¬Ø§Øª ÙˆØ§Ù„Ø³Ù„ÙˆÙƒ"])

    # --- Ø´Ø§Ø´Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ ---
    if page == "ğŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ ÙˆØ§Ù„ØªØ­ÙƒÙ…":
        st.markdown("<h1>ğŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© Ø´Ø¤ÙˆÙ† Ø§Ù„Ø·Ù„Ø§Ø¨ (Ø¥ØµØ¯Ø§Ø± Ù…Ù„ÙƒÙŠ)</h1>", unsafe_allow_True=True)
        tab1, tab2 = st.tabs(["âœ¨ Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨ Ø¬Ø¯ÙŠØ¯", "ğŸ› ï¸ Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"])

        with tab1:
            with st.form("new_student"):
                c1, c2 = st.columns(2)
                with c1:
                    sid = st.number_input("Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠ", min_value=1, step=1)
                    sname = st.text_input("Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„")
                    sphase = st.selectbox("Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©", ["Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠØ©", "Ø§Ù„Ù…ØªÙˆØ³Ø·Ø©", "Ø§Ù„Ø«Ø§Ù†ÙˆÙŠØ©"])
                with c2:
                    sclass = st.selectbox("Ø§Ù„ØµÙ", ["Ø§Ù„Ø£ÙˆÙ„", "Ø§Ù„Ø«Ø§Ù†ÙŠ", "Ø§Ù„Ø«Ø§Ù„Ø«", "Ø§Ù„Ø±Ø§Ø¨Ø¹", "Ø§Ù„Ø®Ø§Ù…Ø³", "Ø§Ù„Ø³Ø§Ø¯Ø³"])
                    syear = st.selectbox("Ø§Ù„Ø³Ù†Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©", ["1446Ù‡Ù€", "1447Ù‡Ù€", "1448Ù‡Ù€"])
                    ssubject = st.text_input("Ø§Ù„Ù…Ø§Ø¯Ø©", value="Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©")
                
                if st.form_submit_button("ğŸš€ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø³Ø­Ø§Ø¨Ø©"):
                    # Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨ØªØ±ØªÙŠØ¨ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©: ID, Name, Phase, Class, Year, Subject
                    ws.append_row([int(sid), sname, sphase, sclass, syear, ssubject])
                    st.success("ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­!")
                    st.rerun()

        with tab2:
            all_data = ws.get_all_records()
            if all_data:
                df = pd.DataFrame(all_data)
                for index, row in df.iterrows():
                    # Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ø´ÙƒÙ„Ø© phase: Ø¥Ø°Ø§ Ù„Ù… ÙŠÙˆØ¬Ø¯ Ø§Ù„Ø¹Ù…ÙˆØ¯ØŒ Ù†Ø¶Ø¹ Ù‚ÙŠÙ…Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
                    p_val = row.get('phase', row.get('Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©', 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'))
                    
                    st.markdown(f"""
                    <div class="student-card">
                        <span style="font-size: 1.2em; font-weight: bold; color: #d4af37;">ğŸ†” {row.get('id', '??')} | ğŸ‘¤ {row.get('name', 'Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…')}</span><br>
                        <span style="color: #666;">Ø§Ù„Ù…Ø±Ø­Ù„Ø©: {p_val} | Ø§Ù„ØµÙ: {row.get('class', '-')} | Ø§Ù„Ù…Ø§Ø¯Ø©: {row.get('subject', 'Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©')}</span>
                    </div>
                    """, unsafe_allow_html=True)
                    
                    c_edit, c_del, c_empty = st.columns([1, 1, 3])
                    with c_edit:
                        if st.button("âœï¸ ØªØ¹Ø¯ÙŠÙ„", key=f"e_{index}"):
                            st.toast("Ø³ÙŠØªÙ… ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù‚Ø±ÙŠØ¨Ø§Ù‹")
                    with c_del:
                        if st.button("ğŸ—‘ï¸ Ø­Ø°Ù", key=f"d_{index}"):
                            ws.delete_rows(int(index) + 2)
                            st.warning("ØªÙ… Ø§Ù„Ø­Ø°Ù.")
                            st.rerun()
            else:
                st.info("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø³Ø¬Ù„Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.")

    elif page == "ğŸ“Š Ø§Ù„Ø¯Ø±Ø¬Ø§Øª ÙˆØ§Ù„Ø³Ù„ÙˆÙƒ":
        st.markdown("<h1>ğŸ“Š Ø±ØµØ¯ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª ÙˆØ§Ù„Ø³Ù„ÙˆÙƒ</h1>", unsafe_allow_html=True)
        st.info("Ù‡Ø°Ù‡ Ø§Ù„Ø´Ø§Ø´Ø© Ø³ØªØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„ØªÙŠ ØªØ³Ø¬Ù„Ù‡Ø§ ÙÙŠ Ø´Ø§Ø´Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©.")

except Exception as e:
    st.error(f"Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª: {e}")
