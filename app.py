import streamlit as st
from streamlit_gsheets import GSheetsConnection
import pandas as pd

# --- Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ---
st.set_page_config(page_title="Ù†Ø¸Ø§Ù… Ø§Ù„Ø£Ø³ØªØ§Ø° Ø²ÙŠØ§Ø¯ Ø§Ù„Ù…Ø¹Ù…Ø±ÙŠ", layout="wide")

# Ø§Ù„Ø±Ø¨Ø· Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠ
conn = st.connection("gsheets", type=GSheetsConnection)

def load_data(sheet_name):
    # Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¹ Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø¤Ù‚Øª (Ù„Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© Ø§Ù„Ø®Ø·Ø£)
    return conn.read(worksheet=sheet_name, ttl="0s")

# --- ÙˆØ§Ø¬Ù‡Ø© Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø·Ø§Ù„Ø¨ (Ø§Ù„Ù…Ø¹Ù„Ù…) ---
st.title("ğŸ‘¥ ØªØ³Ø¬ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨")
with st.form("add_student_form"):
    fid = st.number_input("Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠ", min_value=1)
    fname = st.text_input("Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„ÙƒØ§Ù…Ù„")
    fclass = st.text_input("Ø§Ù„ØµÙ")
    fyear = st.selectbox("Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ", ["1447Ù‡Ù€", "1448Ù‡Ù€"])
    fsem = st.selectbox("Ø§Ù„ÙØµÙ„ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ", ["Ø§Ù„Ø£ÙˆÙ„", "Ø§Ù„Ø«Ø§Ù†ÙŠ", "Ø§Ù„Ø«Ø§Ù„Ø«"])
    
    submit = st.form_submit_button("ğŸ’¾ Ø­ÙØ¸ ÙÙŠ Ø³Ø­Ø§Ø¨Ø© Ø¬ÙˆØ¬Ù„")
    
    if submit:
        if fname:
            try:
                # Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©
                df_existing = load_data("students")
                # Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ø·Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯
                new_row = pd.DataFrame([{"id": fid, "name": fname, "class": fclass, "year": fyear, "sem": fsem}])
                updated_df = pd.concat([df_existing, new_row]).drop_duplicates(subset=['id'], keep='last')
                
                # ØªØ­Ø¯ÙŠØ« Ù…Ù„Ù Ø¬ÙˆØ¬Ù„
                conn.update(worksheet="students", data=updated_df)
                st.success(f"ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨ {fname} Ø¨Ù†Ø¬Ø§Ø­ ÙÙŠ Ù…Ù„ÙÙƒ!")
                st.balloons()
            except Exception as e:
                st.error(f"Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: {e}")
        else:
            st.warning("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨")

# Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø­Ø§Ù„ÙŠ Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©
st.divider()
st.subheader("ğŸ“‹ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙÙŠ Ø¬ÙˆØ¬Ù„ Ø´ÙŠØª")
st.dataframe(load_data("students"), use_container_width=True)
